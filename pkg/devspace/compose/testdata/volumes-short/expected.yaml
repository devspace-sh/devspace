version: v1beta11
images:
  db:
    context: db
    dockerfile: db/Dockerfile
    image: loft.sh/mysql-server:8.0.19
    injectRestartHelper: true

deployments:
- name: db
  helm:
    componentChart: true
    values:
      containers:
      - image: loft.sh/mysql-server:8.0.19
        env:
        - name: DEVSPACE_MANUAL_START
          value: "true"
        volumeMounts:
        - containerPath: /var/lib/mydata
          volume:
            name: db-0
            readOnly: false
        - containerPath: /var/lib/mysql
          volume:
            name: datavolume
            readOnly: false
      volumes:
      - name: datavolume
        size: 5Gi
      - name: db-0
        size: 5Gi

dev:
  sync:
  - labelSelector:
      app.kubernetes.io/component: db
    localSubPath: /opt/data
    containerPath: /var/lib/mysql
  - labelSelector:
      app.kubernetes.io/component: db
    localSubPath: ./cache
    containerPath: /tmp/cache
  - labelSelector:
      app.kubernetes.io/component: db
    localSubPath: $!(echo "$HOME/configs")
    containerPath: /etc/configs/

hooks:
- events: ["devCommand:after:sync"]
  command: /tmp/devspacehelper restart
  container:
    labelSelector:
      app.kubernetes.io/component: db
    imageSelector: loft.sh/mysql-server:8.0.19
    once: true
