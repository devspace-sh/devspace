version: v1beta11

dependencies:
- name: db
  source:
    path: ../db.devspace.yaml
  dev:
    sync: true
    ports: true

images:
  backend:
    image: backend

deployments:
- name: backend
  helm:
    componentChart: true
    values:
      containers:
      - image: backend
        env:
        - name: FLASK_ENV
          value: development
        volumeMounts:
        - containerPath: /run/secrets/db-password
          volume:
            name: db-password
            subPath: db-password
            readOnly: true
      restartPolicy: Always
      service:
        ports:
        - port: 5000
      volumes:
      - name: db-password
        secret:
          secretName: db-password

dev:
  ports:
  - imageSelector: backend
    forward:
    - port: 5000
  sync:
  - imageSelector: backend
    localSubPath: ./
    containerPath: /code/
    excludeFile: .dockerignore

hooks:
- events:
  - before:deploy
  command: |
    kubectl create secret generic db-password --dry-run=client --from-file=db-password=../db/password.txt -o yaml | kubectl apply -f -
- events:
  - after:purge
  command: kubectl delete secret db-password --ignore-not-found
- wait:
    running: true
    terminatedWithCode: 0
  container:
    imageSelector: backend
  events: ["after:deploy:backend"]
