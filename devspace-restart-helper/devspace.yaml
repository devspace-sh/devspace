version: v1beta11

# `vars` specifies variables which may be used as ${VAR_NAME} in devspace.yaml
vars:
- name: IMAGE_PREFIX
- name: REPO
  value: devspace-restart-helper
- name: WORKING_DIR
  value: /.devspace
- name: IMAGE
  value: ${IMAGE_PREFIX}/${REPO}
images:
  alpine:
    image: ${IMAGE_PREFIX}/${REPO}
    build:
      buildKit:
        inCluster:
          name: buildKit-builder
        skipPush: false
        args:
          - --platform
          - linux/amd64
          - --cache-to
          - type=registry,ref=${IMAGE_PREFIX}/${REPO}
          - --cache-from
          - type=registry,ref=${IMAGE_PREFIX}/${REPO}

deployments:
- name: devspace-restart-helper-test
  helm:
    componentChart: true
    values:
      containers:
      - name: devspace-restart-helper
        image: ${IMAGE}
dev:

commands:
- name: attach
  command: devspace attach -c devspace-restart-helper
- name: up
  command: devspace --debug purge && devspace --debug build -b && devspace --debug dev
- name: exec
  command: devspace enter -c devspace-restart-helper
- name: logs
  command: devspace run exec -- cat ${WORKING_DIR}/devspace-restart-helper.log
- name: ps
  command: devspace run exec -- ps aux
- name: devc-alpine
  command: docker stop drh-alpine; docker rm drh-alpine; docker run --name drh-alpine -it -v "$(pwd)":/tmp/dev -w /tmp/dev alpine sh
- name: devc-ubuntu
  command: docker stop drh-ubuntu; docker rm drh-ubuntu; docker run --name drh-ubuntu -it -v "$(pwd)":/tmp/dev -w /tmp/dev ubuntu sh
- name: devc-debian
  command: docker stop drh-debian; docker rm drh-debian; docker run --name drh-debian -it -v "$(pwd)":/tmp/dev -w /tmp/dev debian sh
- name: test-alpine
  command: docker stop drh-alpine; docker rm drh-alpine; docker run --name drh-alpine -it -v "$(pwd)":/tmp/dev alpine /tmp/dev/devspace-restart-helper.sh --development /tmp/dev/test/process.sh
- name: test-ubuntu
  command: docker stop drh-ubuntu; docker rm drh-ubuntu; docker run --name drh-ubuntu -it -v "$(pwd)":/tmp/dev ubuntu /tmp/dev/devspace-restart-helper.sh --development /tmp/dev/test/process.sh
- name: test-debian
  command: docker stop drh-debian; docker rm drh-debian; docker run --name drh-debian -it -v "$(pwd)":/tmp/dev debian /tmp/dev/devspace-restart-helper.sh --development /tmp/dev/test/process.sh
